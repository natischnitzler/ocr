<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Temponovo ¬∑ Ingresar Pedido</title>
<link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#f7f6f3;--white:#ffffff;--ink:#18181b;--ink2:#52525b;--ink3:#a1a1aa;--border:#e4e4e7;--accent:#dc4f00;--accent-bg:#fff4f0;--accent-border:#fecdbb;--green:#16a34a;--green-bg:#f0fdf4;--yellow:#b45309;--yellow-bg:#fffbeb;--red:#dc2626;--red-bg:#fef2f2;--blue:#2563eb;--blue-bg:#eff6ff;--radius:10px;--shadow:0 1px 2px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04);--shadow-md:0 4px 16px rgba(0,0,0,.08)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Figtree',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;font-size:14px;line-height:1.5}
header{background:var(--ink);color:white;padding:0 1.5rem;height:52px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.logo{font-weight:800;font-size:1rem;letter-spacing:-0.02em}
.logo em{color:#dc4f00;font-style:normal}
.status-pill{display:flex;align-items:center;gap:6px;font-size:.72rem;color:rgba(255,255,255,.45);background:rgba(255,255,255,.07);border-radius:100px;padding:4px 10px;transition:all .3s}
.status-pill .dot{width:6px;height:6px;border-radius:50%;background:#52525b;transition:all .3s}
.status-pill.ok{color:#4ade80}.status-pill.ok .dot{background:#4ade80;box-shadow:0 0 6px #4ade80}
.page{max-width:760px;margin:0 auto;padding:2rem 1rem 4rem;display:flex;flex-direction:column;gap:1.25rem}
.card{background:var(--white);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
.card-header{padding:1rem 1.25rem .75rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-weight:700;font-size:.9rem;color:var(--ink);display:flex;align-items:center;gap:.5rem}
.card-body{padding:1.25rem}
.setup-row{display:flex;gap:.75rem;align-items:flex-end}
.field{display:flex;flex-direction:column;gap:.3rem;flex:1}
.field label{font-size:.72rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em}
.field input{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:.6rem .85rem;font-family:'Figtree',sans-serif;font-size:.88rem;color:var(--ink);outline:none;transition:border-color .15s;width:100%}
.field input:focus{border-color:var(--accent)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;border-radius:var(--radius);font-family:'Figtree',sans-serif;font-weight:600;font-size:.85rem;cursor:pointer;transition:all .15s;white-space:nowrap;border:none;padding:.6rem 1.1rem}
.btn-dark{background:var(--ink);color:white}.btn-dark:hover{background:#27272a}.btn-dark:disabled{opacity:.4;cursor:not-allowed}
.btn-accent{background:var(--accent);color:white;box-shadow:0 2px 8px rgba(220,79,0,.25)}.btn-accent:hover{background:#c44300}.btn-accent:disabled{opacity:.4;cursor:not-allowed;box-shadow:none}
.btn-green{background:var(--green);color:white;box-shadow:0 2px 8px rgba(22,163,74,.2)}.btn-green:hover{background:#15803d}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--ink2)}.btn-ghost:hover{border-color:var(--ink);color:var(--ink)}
.steps{display:flex;gap:0;background:var(--bg);border-radius:10px;padding:4px}
.step{flex:1;text-align:center;padding:.5rem;font-size:.78rem;font-weight:600;color:var(--ink3);border-radius:7px;transition:all .2s}
.step.active{background:var(--white);color:var(--ink);box-shadow:var(--shadow)}
.step.done{color:var(--green)}
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:2.5rem 1.5rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg)}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:var(--accent-bg)}
.upload-zone.has-file{border-style:solid;border-color:var(--accent);background:var(--accent-bg);padding:1.25rem 1.5rem}
.upload-icon{font-size:2rem;margin-bottom:.5rem}.upload-title{font-weight:700;font-size:.95rem;margin-bottom:.25rem}.upload-hint{color:var(--ink3);font-size:.8rem}
.file-preview{display:flex;align-items:center;gap:.75rem}
.file-thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border);flex-shrink:0}
.file-thumb.excel-thumb{background:var(--green-bg);border-color:#bbf7d0;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.file-info{flex:1;text-align:left}.file-name{font-weight:600;font-size:.85rem}.file-size{color:var(--ink3);font-size:.75rem}
.btn-remove{background:none;border:none;color:var(--ink3);cursor:pointer;font-size:1rem;padding:4px;border-radius:6px;transition:all .15s}.btn-remove:hover{color:var(--red);background:var(--red-bg)}
input[type=file]{display:none}
.client-search-wrap{position:relative}
.client-search-wrap input{background:var(--bg);border:1.5px solid var(--border);border-radius:var(--radius);padding:.6rem .85rem;font-family:'Figtree',sans-serif;font-size:.88rem;color:var(--ink);outline:none;width:100%;transition:border-color .15s}
.client-search-wrap input:focus{border-color:var(--accent)}
.client-selected{display:flex;align-items:center;justify-content:space-between;background:var(--green-bg);border:1.5px solid #bbf7d0;border-radius:var(--radius);padding:.6rem .85rem}
.client-selected-name{font-weight:600;color:var(--green);font-size:.9rem}
.dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--white);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow-md);z-index:100;max-height:240px;overflow-y:auto;display:none}
.dropdown.open{display:block}
.dd-item{padding:.6rem .85rem;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border)}.dd-item:last-child{border-bottom:none}.dd-item:hover{background:var(--accent-bg)}
.dd-name{font-weight:600;font-size:.85rem}.dd-ref{color:var(--ink3);font-size:.72rem}
.dd-empty{padding:1rem;text-align:center;color:var(--ink3);font-size:.82rem}
.processing-card{text-align:center;padding:2.5rem 1.5rem}
.processing-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 1rem}
@keyframes spin{to{transform:rotate(360deg)}}
.processing-title{font-weight:700;font-size:1rem;margin-bottom:.4rem}.processing-sub{color:var(--ink3);font-size:.85rem}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.83rem}
thead th{background:var(--bg);padding:.55rem .85rem;text-align:left;font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--ink3);border-bottom:1px solid var(--border);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:#fafaf9}
tbody tr.rejected{opacity:.35;background:var(--red-bg)}
tbody tr.rejected td{text-decoration:line-through}
tbody td{padding:.5rem .85rem;vertical-align:middle}
.prod-wrap{position:relative}
.prod-input{font-family:'Figtree',monospace;font-weight:700;font-size:.8rem;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;padding:.35rem .55rem;width:140px;outline:none;transition:all .15s;color:var(--ink)}
.prod-input:focus{border-color:var(--blue);background:var(--blue-bg)}
.prod-input.ok{border-color:var(--green);background:var(--green-bg);color:var(--green)}
.prod-input.warn{border-color:#f59e0b;background:var(--yellow-bg);color:var(--yellow)}
.prod-input.err{border-color:var(--red);background:var(--red-bg);color:var(--red)}
.prod-dropdown{position:absolute;top:calc(100% + 3px);left:0;background:var(--white);border:1px solid var(--border);border-radius:9px;box-shadow:var(--shadow-md);z-index:200;max-height:200px;overflow-y:auto;min-width:280px;display:none}
.prod-dropdown.open{display:block}
.pd-item{padding:.5rem .75rem;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s}.pd-item:last-child{border-bottom:none}.pd-item:hover{background:var(--accent-bg)}
.pd-code{font-weight:700;font-size:.75rem;color:var(--blue);font-family:monospace}.pd-name{font-size:.73rem;color:var(--ink2)}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:100px;font-size:.67rem;font-weight:700;white-space:nowrap}
.badge-ok{background:var(--green-bg);color:var(--green);border:1px solid #bbf7d0}
.badge-med{background:var(--yellow-bg);color:var(--yellow);border:1px solid #fde68a}
.badge-low{background:var(--red-bg);color:var(--red);border:1px solid #fecaca}
.qty-input{width:60px;text-align:right;font-weight:700;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;padding:.3rem .5rem;font-family:'Figtree',sans-serif;font-size:.85rem;outline:none;transition:border-color .15s}
.qty-input:focus{border-color:var(--accent)}
.btn-row-action{background:none;border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:.72rem;font-family:'Figtree',sans-serif;cursor:pointer;transition:all .15s;color:var(--ink2);font-weight:600}
.btn-row-action.del{color:var(--red);border-color:#fecaca}.btn-row-action.del:hover{background:var(--red-bg)}
.btn-row-action.restore{color:var(--green);border-color:#bbf7d0}.btn-row-action.restore:hover{background:var(--green-bg)}
.summary-row{display:flex;gap:.75rem;flex-wrap:wrap}
.sum-pill{flex:1;min-width:80px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:.75rem 1rem;text-align:center}
.sum-val{font-size:1.5rem;font-weight:800;line-height:1}.sum-label{font-size:.7rem;color:var(--ink3);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.sum-val.ok{color:var(--green)}.sum-val.warn{color:var(--yellow)}.sum-val.bad{color:var(--red)}
.actions-row{display:flex;gap:.75rem;flex-wrap:wrap;justify-content:space-between;align-items:center}
.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--ink);color:white;border-radius:10px;padding:.75rem 1.1rem;font-size:.85rem;font-weight:500;z-index:9999;transform:translateY(60px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--shadow-md)}
.toast.show{transform:none;opacity:1}
.toast.ok{border-left:3px solid #4ade80}.toast.err{border-left:3px solid #f87171}.toast.warn{border-left:3px solid #fbbf24}
@media(max-width:600px){.setup-row{flex-direction:column}}
</style>
</head>
<body>
<header>
  <div class="logo">Tempo<em>novo</em> ¬∑ Pedidos</div>
  <div class="status-pill" id="statusPill"><span class="dot"></span><span id="statusText">Cargando...</span></div>
</header>
<div class="page">
  <!-- Setup -->
  <div class="card" id="setupCard">
    <div class="card-header"><div class="card-title">‚öôÔ∏è Configuraci√≥n del servidor</div><span style="font-size:.72rem;color:var(--ink3)">Solo la primera vez</span></div>
    <div class="card-body">
      <div class="setup-row">
        <div class="field"><label>URL del proxy (Render)</label><input type="text" id="proxyUrl" placeholder="https://temponovo-odoo-proxy.onrender.com"></div>
        <button class="btn btn-dark" onclick="initProxy()" id="btnInit">Conectar</button>
      </div>
    </div>
  </div>
  <!-- Steps -->
  <div class="steps" id="stepsBar" style="display:none">
    <div class="step active" id="step1">1 ¬∑ Archivo</div>
    <div class="step" id="step2">2 ¬∑ Cliente</div>
    <div class="step" id="step3">3 ¬∑ Revisar</div>
    <div class="step" id="step4">4 ¬∑ Descargar</div>
  </div>
  <!-- Upload -->
  <div class="card" id="cardUpload" style="display:none">
    <div class="card-header"><div class="card-title">üìÅ Sube el pedido</div></div>
    <div class="card-body" style="display:flex;flex-direction:column;gap:1rem">
      <div class="upload-zone" id="zonePhoto" onclick="document.getElementById('inputPhoto').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event,'photo')">
        <div id="zonePhotoContent"><div class="upload-icon">üì∏</div><div class="upload-title">Foto del pedido</div><div class="upload-hint">JPG, PNG, WEBP ¬∑ arrastra o haz clic</div></div>
      </div>
      <input type="file" id="inputPhoto" accept="image/*" onchange="handleFile('photo',this)">
      <div style="text-align:center;color:var(--ink3);font-size:.8rem;font-weight:600">‚Äî o ‚Äî</div>
      <div class="upload-zone" id="zoneExcel" onclick="document.getElementById('inputExcel').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event,'excel')">
        <div id="zoneExcelContent"><div class="upload-icon">üìä</div><div class="upload-title">Excel del pedido</div><div class="upload-hint">XLS, XLSX, CSV ¬∑ arrastra o haz clic</div></div>
      </div>
      <input type="file" id="inputExcel" accept=".xls,.xlsx,.csv" onchange="handleFile('excel',this)">
      <button class="btn btn-accent" id="btnProcess" onclick="processFile()" disabled style="margin-top:.5rem">‚ö° Procesar con IA</button>
    </div>
  </div>
  <!-- Processing -->
  <div class="card" id="cardProcessing" style="display:none">
    <div class="card-body">
      <div class="processing-card">
        <div class="processing-spinner"></div>
        <div class="processing-title" id="processingTitle">Analizando el pedido...</div>
        <div class="processing-sub" id="processingSub">La IA est√° leyendo el archivo y buscando los productos</div>
      </div>
    </div>
  </div>
  <!-- Client -->
  <div class="card" id="cardClient" style="display:none">
    <div class="card-header"><div class="card-title">üë§ ¬øDe qui√©n es este pedido?</div></div>
    <div class="card-body" style="display:flex;flex-direction:column;gap:1rem">
      <div id="clientSelectorWrap">
        <div class="client-search-wrap" id="clientSearchWrap">
          <input type="text" id="clientSearch" placeholder="Escribe el nombre del cliente..." oninput="searchClients(this.value)" onblur="setTimeout(()=>closeClientDd(),200)" autocomplete="off">
          <div class="dropdown" id="clientDd"></div>
        </div>
      </div>
      <button class="btn btn-accent" id="btnConfirmClient" onclick="confirmClient()" disabled>Confirmar cliente ‚Üí</button>
    </div>
  </div>
  <!-- Review -->
  <div class="card" id="cardReview" style="display:none">
    <div class="card-header">
      <div class="card-title">‚úÖ Revisar l√≠neas del pedido</div>
      <button class="btn btn-ghost" onclick="addEmptyRow()" style="padding:4px 10px;font-size:.78rem">+ Agregar</button>
    </div>
    <div class="card-body" style="padding:0">
      <div class="table-scroll">
        <table>
          <thead><tr><th>#</th><th>C√≥digo</th><th>Nombre producto</th><th>Cant.</th><th>Confianza</th><th></th></tr></thead>
          <tbody id="reviewBody"></tbody>
        </table>
      </div>
    </div>
    <div style="padding:1rem 1.25rem;border-top:1px solid var(--border)"><div class="summary-row" id="summaryRow"></div></div>
    <div style="padding:0 1.25rem 1.25rem">
      <div class="actions-row">
        <button class="btn btn-ghost" onclick="clearRejected()">üóë Limpiar rechazados</button>
        <button class="btn btn-green" onclick="downloadExcel()">‚¨á Descargar Excel para Odoo</button>
      </div>
    </div>
  </div>
  <!-- New order -->
  <div id="newOrderBtn" style="display:none;text-align:center">
    <button class="btn btn-dark" onclick="resetAll()">+ Ingresar nuevo pedido</button>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
let PROXY=localStorage.getItem('tn_proxy')||'';
let catalog=[],customers=[],selectedClient=null,currentFile=null,currentFileType=null,rows=[];

window.addEventListener('load',async()=>{
  const saved=localStorage.getItem('tn_proxy');
  if(saved){document.getElementById('proxyUrl').value=saved;await initProxy(true);}
  else{setStatus('Ingresa la URL del proxy');}
});

async function initProxy(silent=false){
  const url=document.getElementById('proxyUrl').value.trim().replace(/\/$/,'');
  if(!url){toast('Ingresa la URL del proxy','err');return;}
  PROXY=url;
  const btn=document.getElementById('btnInit');
  btn.textContent='Conectando...';btn.disabled=true;
  try{
    const h=await fetchJSON(PROXY+'/');
    if(h.status!=='ok')throw new Error('Proxy no responde');
    setStatus('Cargando cat√°logo...');
    const cat=await fetchJSON(PROXY+'/catalog');
    if(!cat.ok)throw new Error(cat.detail||'Error cat√°logo');
    catalog=cat.products;
    const cust=await fetchJSON(PROXY+'/customers');
    if(cust.ok)customers=cust.customers;
    localStorage.setItem('tn_proxy',PROXY);
    setStatus(catalog.length+' productos ¬∑ listo',true);
    document.getElementById('setupCard').style.display='none';
    document.getElementById('stepsBar').style.display='flex';
    document.getElementById('cardUpload').style.display='block';
    setStep(1);
    if(!silent)toast('Conectado ¬∑ '+catalog.length+' productos ‚úì','ok');
  }catch(e){setStatus('Error de conexi√≥n');toast(e.message,'err');}
  btn.textContent='Conectar';btn.disabled=false;
}

function handleDrop(e,type){
  e.preventDefault();
  document.getElementById('zone'+cap(type)).classList.remove('dragover');
  const f=e.dataTransfer.files[0];
  if(f)setFile(type,f);
}

function handleFile(type,input){
  const f=input.files[0];
  if(f)setFile(type,f);
  input.value='';
}

function setFile(type,file){
  if(type==='photo')clearFileZone('excel');else clearFileZone('photo');
  currentFile=file;currentFileType=type;
  const zone=document.getElementById('zone'+cap(type));
  const content=document.getElementById('zone'+cap(type)+'Content');
  zone.classList.add('has-file');zone.onclick=null;
  if(type==='photo'){
    const url=URL.createObjectURL(file);
    content.innerHTML='<div class="file-preview"><img class="file-thumb" src="'+url+'"><div class="file-info"><div class="file-name">'+esc(file.name)+'</div><div class="file-size">'+(file.size/1024).toFixed(0)+' KB</div></div><button class="btn-remove" onclick="event.stopPropagation();clearFileZone(\'photo\')">‚úï</button></div>';
  }else{
    content.innerHTML='<div class="file-preview"><div class="file-thumb excel-thumb">üìä</div><div class="file-info"><div class="file-name">'+esc(file.name)+'</div><div class="file-size">'+(file.size/1024).toFixed(0)+' KB</div></div><button class="btn-remove" onclick="event.stopPropagation();clearFileZone(\'excel\')">‚úï</button></div>';
  }
  document.getElementById('btnProcess').disabled=false;
}

function clearFileZone(type){
  const zone=document.getElementById('zone'+cap(type));
  const content=document.getElementById('zone'+cap(type)+'Content');
  zone.classList.remove('has-file','dragover');
  zone.onclick=()=>document.getElementById('input'+cap(type)).click();
  if(type==='photo'){content.innerHTML='<div class="upload-icon">üì∏</div><div class="upload-title">Foto del pedido</div><div class="upload-hint">JPG, PNG, WEBP ¬∑ arrastra o haz clic</div>';}
  else{content.innerHTML='<div class="upload-icon">üìä</div><div class="upload-title">Excel del pedido</div><div class="upload-hint">XLS, XLSX, CSV ¬∑ arrastra o haz clic</div>';}
  if(currentFileType===type){currentFile=null;currentFileType=null;document.getElementById('btnProcess').disabled=true;}
}

async function processFile(){
  if(!currentFile)return;
  document.getElementById('cardUpload').style.display='none';
  document.getElementById('cardProcessing').style.display='block';
  setStep(2);
  try{
    let rawRows=[];
    if(currentFileType==='photo'){
      document.getElementById('processingTitle').textContent='Leyendo la foto...';
      document.getElementById('processingSub').textContent='Claude est√° analizando la imagen y buscando los productos en el cat√°logo';
      const fd=new FormData();
      fd.append('file',currentFile);
      fd.append('catalog_json',JSON.stringify(catalog));
      const resp=await fetch(PROXY+'/process-image',{method:'POST',body:fd});
      const data=await resp.json();
      if(!data.ok)throw new Error(data.detail||'Error procesando imagen');
      rawRows=data.rows;
    }else{
      document.getElementById('processingTitle').textContent='Leyendo el Excel...';
      document.getElementById('processingSub').textContent='Claude est√° interpretando las columnas y mapeando los productos';
      const text=await readExcelAsText(currentFile);
      const resp=await fetch(PROXY+'/process-text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,filename:currentFile.name,catalog_json:JSON.stringify(catalog)})});
      const data=await resp.json();
      if(!data.ok)throw new Error(data.detail||'Error procesando Excel');
      rawRows=data.rows;
    }
    rows=rawRows.map(r=>({...r,source:currentFileType,rejected:false,matchStatus:getMatchStatus(r.codigo,r.confidence)}));
    const firstClient=rawRows.find(r=>r.cliente&&r.cliente.trim())?.cliente?.trim();
    document.getElementById('cardProcessing').style.display='none';
    showClientStep(firstClient);
  }catch(e){
    document.getElementById('cardProcessing').style.display='none';
    document.getElementById('cardUpload').style.display='block';
    toast('Error: '+e.message,'err');setStep(1);
  }
}

function showClientStep(suggested){
  document.getElementById('cardClient').style.display='block';
  setStep(2);
  if(suggested){document.getElementById('clientSearch').value=suggested;searchClients(suggested);}
}

let cst;
async function searchClients(q){
  clearTimeout(cst);
  const dd=document.getElementById('clientDd');
  if(!q||q.length<2){dd.classList.remove('open');return;}
  cst=setTimeout(async()=>{
    try{
      const local=customers.filter(c=>c.name.toLowerCase().includes(q.toLowerCase())).slice(0,20);
      if(local.length){renderClientDd(local);}
      else{const data=await fetchJSON(PROXY+'/customers?q='+encodeURIComponent(q));if(data.ok)renderClientDd(data.customers);}
    }catch(e){}
  },250);
}

function renderClientDd(list){
  const dd=document.getElementById('clientDd');
  if(!list.length){dd.innerHTML='<div class="dd-empty">Sin resultados</div>';}
  else{dd.innerHTML=list.map(c=>'<div class="dd-item" onmousedown="selectClient('+c.id+',\''+esc(c.name)+'\',\''+esc(c.ref||'')+'\')"><div class="dd-name">'+esc(c.name)+'</div>'+(c.ref?'<div class="dd-ref">Ref: '+esc(c.ref)+'</div>':'')+'</div>').join('');}
  dd.classList.add('open');
}

function selectClient(id,name,ref){
  selectedClient={id,name,ref};
  document.getElementById('clientSearchWrap').innerHTML='<div class="client-selected"><div class="client-selected-name">‚úì '+esc(name)+'</div><button class="btn-remove" onclick="clearClient()">‚úï</button></div>';
  document.getElementById('btnConfirmClient').disabled=false;
}

function clearClient(){
  selectedClient=null;
  document.getElementById('clientSearchWrap').innerHTML='<input type="text" id="clientSearch" placeholder="Escribe el nombre del cliente..." oninput="searchClients(this.value)" onblur="setTimeout(()=>closeClientDd(),200)" autocomplete="off"><div class="dropdown" id="clientDd"></div>';
  document.getElementById('btnConfirmClient').disabled=true;
}

function closeClientDd(){const dd=document.getElementById('clientDd');if(dd)dd.classList.remove('open');}

function confirmClient(){
  if(!selectedClient)return;
  rows=rows.map(r=>({...r,cliente:selectedClient.name}));
  document.getElementById('cardClient').style.display='none';
  showReview();
}

function showReview(){
  document.getElementById('cardReview').style.display='block';
  document.getElementById('newOrderBtn').style.display='block';
  setStep(3);renderReview();updateSummary();
}

function renderReview(){
  const tbody=document.getElementById('reviewBody');tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');tr.id='tr-'+i;
    if(r.rejected)tr.classList.add('rejected');
    const cb={'high':'<span class="badge badge-ok">‚úì Alta</span>','medium':'<span class="badge badge-med">~ Media</span>','low':'<span class="badge badge-low">‚úó Baja</span>'}[r.confidence]||'';
    tr.innerHTML='<td style="color:var(--ink3);font-weight:700;font-size:.75rem">'+(i+1)+'</td><td><div class="prod-wrap"><input class="prod-input '+prodClass(r)+'" id="pi-'+i+'" value="'+esc(r.codigo||'')+'" oninput="onProdInput('+i+',this)" onblur="setTimeout(()=>closeProdDd('+i+'),180)" autocomplete="off"><div class="prod-dropdown" id="pd-'+i+'"></div></div></td><td style="color:var(--ink2);font-size:.8rem;max-width:200px" id="pname-'+i+'">'+esc(r.nombre_producto||'')+'</td><td><input class="qty-input" value="'+(r.cantidad||1)+'" type="number" min="0.01" step="any" onchange="rows['+i+'].cantidad=parseFloat(this.value)||1;updateSummary()"></td><td>'+cb+(r.nota_ia?'<br><span style="font-size:.68rem;color:var(--ink3)">'+esc(r.nota_ia)+'</span>':'')+'</td><td>'+(r.rejected?'<button class="btn-row-action restore" onclick="restoreRow('+i+')">‚Ü©</button>':'<button class="btn-row-action del" onclick="rejectRow('+i+')">‚úï</button>')+'</td>';
    tbody.appendChild(tr);
  });
}

function prodClass(r){if(r.matchStatus==='ok')return 'ok';if(['partial','name'].includes(r.matchStatus))return 'warn';if(r.matchStatus==='not-found')return 'err';return '';}

function getMatchStatus(code,confidence){
  if(!catalog.length)return 'no-catalog';
  const c=(code||'').trim().toUpperCase();
  if(catalog.find(p=>p.code.toUpperCase()===c))return 'ok';
  if(catalog.find(p=>p.code.toUpperCase().includes(c)||c.includes(p.code.toUpperCase())))return 'partial';
  if(confidence==='high')return 'ok';
  if(confidence==='medium')return 'partial';
  return 'not-found';
}

function onProdInput(i,input){
  const val=input.value.trim();rows[i].codigo=val;
  const pd=document.getElementById('pd-'+i);
  if(!val||val.length<2){pd.classList.remove('open');return;}
  const matches=catalog.filter(p=>p.code.toUpperCase().includes(val.toUpperCase())||p.name.toLowerCase().includes(val.toLowerCase())).slice(0,10);
  if(!matches.length){pd.classList.remove('open');return;}
  pd.innerHTML=matches.map(p=>'<div class="pd-item" onmousedown="selectProd('+i+',\''+esc(p.code)+'\',\''+esc(p.name)+'\')"><div class="pd-code">'+p.code+'</div><div class="pd-name">'+p.name+'</div></div>').join('');
  pd.classList.add('open');
}

function selectProd(i,code,name){
  rows[i].codigo=code;rows[i].nombre_producto=name;rows[i].matchStatus='ok';rows[i].confidence='high';
  const inp=document.getElementById('pi-'+i);if(inp){inp.value=code;inp.className='prod-input ok';}
  const pn=document.getElementById('pname-'+i);if(pn)pn.textContent=name;
  closeProdDd(i);updateSummary();
}

function closeProdDd(i){const pd=document.getElementById('pd-'+i);if(pd)pd.classList.remove('open');}

function rejectRow(i){
  rows[i].rejected=true;
  document.getElementById('tr-'+i)?.classList.add('rejected');
  const td=document.querySelector('#tr-'+i+' td:last-child');
  if(td)td.innerHTML='<button class="btn-row-action restore" onclick="restoreRow('+i+')">‚Ü©</button>';
  updateSummary();
}

function restoreRow(i){
  rows[i].rejected=false;
  document.getElementById('tr-'+i)?.classList.remove('rejected');
  const td=document.querySelector('#tr-'+i+' td:last-child');
  if(td)td.innerHTML='<button class="btn-row-action del" onclick="rejectRow('+i+')">‚úï</button>';
  updateSummary();
}

function clearRejected(){rows=rows.filter(r=>!r.rejected);renderReview();updateSummary();toast('Filas rechazadas eliminadas','ok');}

function addEmptyRow(){
  rows.push({cliente:selectedClient?.name||'',codigo:'',nombre_producto:'',cantidad:1,confidence:'high',matchStatus:'no-catalog',rejected:false});
  renderReview();updateSummary();
  setTimeout(()=>document.getElementById('pi-'+(rows.length-1))?.focus(),50);
}

function updateSummary(){
  const active=rows.filter(r=>!r.rejected);
  const ok=active.filter(r=>r.matchStatus==='ok').length;
  const warn=active.filter(r=>['partial','name'].includes(r.matchStatus)).length;
  const bad=active.filter(r=>r.matchStatus==='not-found').length;
  document.getElementById('summaryRow').innerHTML='<div class="sum-pill"><div class="sum-val">'+active.length+'</div><div class="sum-label">Total</div></div><div class="sum-pill"><div class="sum-val ok">'+ok+'</div><div class="sum-label">Exactos</div></div><div class="sum-pill"><div class="sum-val warn">'+warn+'</div><div class="sum-label">Revisar</div></div><div class="sum-pill"><div class="sum-val bad">'+bad+'</div><div class="sum-label">No encontrados</div></div>';
}

function downloadExcel(){
  const active=rows.filter(r=>!r.rejected&&r.codigo);
  if(!active.length){toast('No hay l√≠neas para exportar','warn');return;}
  const clientName=selectedClient?.name||active[0]?.cliente||'CLIENTE';
  const data=[['Cliente','L√≠neas del pedido/Producto/Referencia interna','L√≠neas del pedido/Cantidad']];
  active.forEach((r,i)=>data.push([i===0?clientName:null,r.codigo,parseFloat(r.cantidad)||1]));
  const ws=XLSX.utils.aoa_to_sheet(data);
  ws['!cols']=[{wch:32},{wch:28},{wch:12}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Pedido');
  const safe=clientName.replace(/[^a-zA-Z0-9]/g,'_').slice(0,30);
  const date=new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb,'pedido_'+safe+'_'+date+'.xlsx');
  setStep(4);toast('Excel descargado ¬∑ '+active.length+' l√≠neas ‚úì','ok');
}

function resetAll(){
  rows=[];selectedClient=null;currentFile=null;currentFileType=null;
  clearFileZone('photo');clearFileZone('excel');
  document.getElementById('cardClient').style.display='none';
  document.getElementById('cardReview').style.display='none';
  document.getElementById('newOrderBtn').style.display='none';
  document.getElementById('cardUpload').style.display='block';
  document.getElementById('btnProcess').disabled=true;
  clearClient();setStep(1);
}

async function readExcelAsText(file){
  const data=await file.arrayBuffer();
  const wb=XLSX.read(data,{type:'array'});
  let text='';
  wb.SheetNames.forEach(name=>{text+='\n--- Hoja: '+name+' ---\n'+XLSX.utils.sheet_to_csv(wb.Sheets[name]);});
  return text;
}

async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);return r.json();}
function cap(s){return s[0].toUpperCase()+s.slice(1);}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function setStatus(text,ok=false){document.getElementById('statusText').textContent=text;document.getElementById('statusPill').className='status-pill'+(ok?' ok':'');}
function setStep(n){for(let i=1;i<=4;i++){const el=document.getElementById('step'+i);if(!el)continue;el.className='step'+(i===n?' active':i<n?' done':'');}}
let toastT;
function toast(msg,type='ok'){const el=document.getElementById('toast');el.textContent=msg;el.className='toast '+type+' show';clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3500);}
</script>
</body>
</html>
